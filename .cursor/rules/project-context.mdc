---
description: Core project context for the Canvas MCP server. Read this FIRST when starting any work session.
globs:
  - "**/*.ts"
  - "**/*.json"
alwaysApply: true
---

# Canvas MCP Server — Project Context

## What This Is
An MCP (Model Context Protocol) server that connects Claude to Canvas LMS at UW-Madison (canvas.wisc.edu). The user is a **student** who wants Claude to be their all-in-one Canvas assistant — tracking deadlines, checking grades, reading course content.

## Architecture

### Entry Point
- `src/index.ts` — Creates McpServer, registers all tools/prompts/resources, connects via StdioServerTransport

### Core
- `src/canvas-client.ts` — Canvas REST API wrapper (singleton via `getCanvasClient()`)
  - Has SSRF protection (origin validation), request timeouts (30s), pagination guards (100 pages / 10k items)
  - Error messages are sanitized to prevent token leakage
- `src/utils.ts` — Shared utilities (HTML stripping, PDF parsing, error/success formatters)
- `src/types/canvas.ts` — All TypeScript interfaces mirroring Canvas API objects

### Tools (src/tools/)
| File | Tools | Write? |
|------|-------|--------|
| dashboard.ts | daily_briefing, get_my_profile | No |
| planner.ts | get_planner_items, get_planner_notes, create_planner_note, mark_planner_item_done, delete_planner_note | Safe writes (personal only) |
| courses.ts | list_courses, get_course | No |
| assignments.ts | list_assignments, get_assignment, get_rubric | No |
| grades.ts | get_my_grades, get_my_submission_status | No |
| search.ts | find_assignments_by_due_date, get_upcoming_assignments, get_overdue_assignments, search_course_content, get_all_upcoming_work | No |
| modules.ts | list_modules, list_announcements, get_module_item_content | No |
| pages.ts | list_pages, get_page_content | No |
| files.ts | list_course_files, get_file_info, read_file_content | No |
| calendar.ts | list_calendar_events | No |
| todos.ts | get_my_todo_items | No |
| discussions.ts | list_discussions, get_discussion_entries, post_discussion_entry*, reply_to_discussion* | *Gated |
| submissions.ts | get_submission, submit_assignment*, upload_file* | *Gated |

### MCP Features Beyond Tools
- `src/prompts.ts` — 4 prompt templates: weekly_review, study_plan, assignment_helper, quick_check
- `src/resources.ts` — 4 resources: grades/summary, courses/active, courses/{id}/syllabus, courses/{id}/assignments

## Safety Model
- **Always on**: All reads + planner notes + mark complete (personal, zero-risk)
- **Gated by ENABLE_WRITE_TOOLS=true**: submit_assignment, upload_file, post_discussion_entry, reply_to_discussion

## Key Patterns
- All tools use `formatError()` and `formatSuccess()` from utils.ts
- All HTML from Canvas is auto-stripped to clean text via `stripHtmlTags()`
- Dashboard uses `Promise.allSettled` for graceful degradation
- Canvas client has 30s default timeout, 60s for file downloads

## Environment Variables
- `CANVAS_API_TOKEN` (required) — Canvas API token
- `CANVAS_BASE_URL` (required) — e.g., https://canvas.wisc.edu
- `ENABLE_WRITE_TOOLS` (optional) — "true" to enable submission/discussion writes
